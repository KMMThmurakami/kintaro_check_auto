## ツールの説明
playwrightを使用してメンバーの勤怠入力状況を自動チェックします

※「勤太郎 入力状況チェックbot」のブラウザ拡張機能と組み合わせて使う必要があります

## ツールの配置ディレクトリに関する注意(Mac)
後述するcronでの定期実行を行う際、デスクトップ配下などにツールを配置するとプライバシーとセキュリティのポップアップが毎回表示されるため、回避するには`/Users/ユーザーID/`直下などにツールを配置してみてください。

※windowsのタスクスケジューラ使用時の挙動は未確認

## 初期設定
### ブラウザ拡張機能の準備
- ブラウザ拡張機能を入手する
  - slackなどでzipを配布しています
- 一度自分のブラウザにインストールし、拡張機能IDを確認する
  - chromeの場合
  - `chrome://extensions/`にアクセス
  - 「パッケージ化されていない拡張機能を読み込む」から、事前に入手した拡張機能をインストールする
  - 「すべての拡張機能」のところで、「勤太郎 入力状況チェックbot」のIDを確認する
- ※ID確認後は自分のブラウザから拡張機能を削除してOK
- ※拡張機能自体は手動でも使えるようにしています

### Microsoft365 TOPT Secret keyを発行する
参考:https://www.eliostruyf.com/automating-microsoft-365-login-mfa-playwright-tests/

勤太郎ログイン時、MicrosoftのMFA（多要素認証）を求められます。
playwrightで動かす際にMFAを突破するため、TOPTのSecret keyを取得します。

手順
- 認証したいM365アカウントで以下にアクセス
  - https://mysignins.microsoft.com/security-info
- 「サインイン方法の追加」を選択
- 「Microsoft Authenticator」を選択
- 「別の認証アプリを使用します」を選択
- QR コードスキャン画面で「画像をスキャンできませんか？」を選択
- 表示されたSecret key（秘密鍵）をコピー
  - ※1回しか表示されないので忘れたら作り直しが必要
- 認証アプリを使用してQRコードをスキャン
- 次へボタンをクリック
- 認証アプリからコードを入力し、「次へ」ボタンをクリック

### playwrightの準備
- `npm install`
- `.env`に以下の5項目を記載
  - 拡張機能ファイルパス
  - 拡張機能ID
  - Microsoft365アカウント
    - メールアドレス
    - パスワード
    - TOPT Secret key
- 拡張機能の事前設定
  - channel_settings.csv
    - 投稿するslackチャンネルのIDとグループ名の組み合わせを設定します
  - mention_settings.csv
    - グループ名、勤太郎登録名、メンション用のslackユーザーIDを設定します
  - 上記の2ファイルは拡張機能のオプション画面上で設定してcsvファイルをエクスポートすることもできます

上記が必要最低限な設定です。
ここまでの設定が完了すると、コマンド実行でplaywrightを起動することができます。

```
npm run playwright
```

コマンド実行するとplaywright経由でブラウザが立ち上がり、
拡張機能読み込み→勤太郎アクセス→拡張機能起動→slack投稿が実行されます。

## 定周期自動実行設定
さらに以下の設定を行うことで定周期で本ツールを実行することができます。

※以下に紹介する方法以外でも定周期実行できる方法をご存知でしたらお試しください

### Mac
- vpnConnect.shの設定
  - このシェルはエニコネ接続されているか確認し、未接続ならエニコネ接続後にplaywright起動、接続済みならそのままplaywrightを起動します
  - 以下2項目を設定
    - エニーコネクト接続時のパスワード
    - 本ツールpackage.jsonのパス
  - 実行権限を付与
    - chmod 755 (シェルのファイルパス)/vpnConnect.sh

- crontabの登録
  - cron.confを設定
    - npmのPATHが通っている環境変数をcron内で設定しないとnpmコマンドが実行できない
    - cronに登録するシェルスクリプトのファイルパスは絶対パスを記載する
  - crontabを登録
    - `crontab -l`で現在登録されているタスクを確認
      - ※すでにcronが設定されているようだったらバックアップを取ることをおすすめします
    - cron.confを読み込ませる
      - `crontab (ファイルパス)/cron.conf`

### windows
#### お詫び
作者はwindows端末未所持のため、vpnConnect.shのようなコマンドラインからエニーコネクト接続する手段が不明です。

申し訳ないですが、windows端末利用者は事前にエニーコネクト接続している前提で定周期実行させてください。

- タスクスケジューラの設定
  - タスクスケジューラにplaywrightを起動するbatファイルを登録
